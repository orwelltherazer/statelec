{% extends "base.twig" %}

{% block title %}Diagnostic - Statelec{% endblock %}

{% block content %}
<main class="p-2 sm:p-3 space-y-3">
    <div class="bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold mb-6">État du module</h1>
        <div class="space-y-4">
                <div class="flex items-center justify-between p-3 {% if moduleStatus == 'online' %}bg-green-50 dark:bg-green-900/20{% else %}bg-red-50 dark:bg-red-900/20{% endif %} rounded-lg">
                    <div>
                        <div class="font-semibold {% if moduleStatus == 'online' %}text-green-800{% else %}text-red-800{% endif %}">Module Linky</div>
                        <div class="text-sm {% if moduleStatus == 'online' %}text-green-600{% else %}text-red-600{% endif %}">Statut: {{ moduleStatus }}</div>
                    </div>
                    {% if moduleStatus == 'online' %}
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    {% else %}
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
                    {% endif %}
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    <div class="p-3 rounded-lg bg-gray-50 dark:bg-gray-700">
                        <div class="text-sm text-gray-500 dark:text-gray-400">Dernière mise à jour</div>
                        <div class="font-semibold mt-1">{{ lastRecordTimestamp }}</div>
                    </div>

                    <div class="p-4 rounded-lg bg-gray-50 dark:bg-gray-700">
                        <div class="text-sm text-gray-500 dark:text-gray-400">Données en base</div>
                        <div class="font-semibold mt-1">{{ recordCount }} entrées</div>
                    </div>




            </div>
        </div>

    </div>


    
    <div class="bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-semibold mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M3 5V19A9 3 0 0 0 21 19V5"></path><path d="M3 12A9 3 0 0 0 21 12"></path></svg>
            Enregistrements en base de données
        </h2>
        
            <div class="mb-4 flex items-center justify-between">
                <div class="text-sm text-gray-500 dark:text-gray-400">
                    Total: <span id="db-total-records">{{ recordCount }}</span> enregistrements
                </div>
                <button
                    id="refresh-db-records"
                    class="px-3 py-1 rounded text-sm bg-blue-600 text-white hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600"
                >
                    Actualiser
                </button>
            </div>

            <div class="rounded-lg overflow-hidden bg-gray-100 dark:bg-gray-900">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-200 dark:bg-gray-800">
                        <tr>
                            <th class="px-4 py-2 text-left">Timestamp</th>
                            <th class="px-4 py-2 text-left">Puissance (W)</th>
                            <th class="px-4 py-2 text-left">Index HC</th>
                            <th class="px-4 py-2 text-left">Index HP</th>
                            <th class="px-4 py-2 text-left">Période</th>
                        </tr>
                    </thead>
                    <tbody id="db-records-body">
                        {# Records will be loaded here by JS #}
                    </tbody>
                </table>
                
                    <div id="no-records-message" class="text-center py-8 text-gray-500 dark:text-gray-400 hidden">
                        Aucun enregistrement trouvé
                    </div>

                    <div id="loading-db-message" class="text-center py-8 text-gray-500 dark:text-gray-400 hidden">
                        Chargement des enregistrements...
                    </div>
            </div>
        </div>

            <div id="pagination-controls" class="mt-4 flex items-center justify-between hidden">
                <div class="text-sm text-gray-500 dark:text-gray-400">
                    Page <span id="current-page">1</span> sur <span id="total-pages">1</span>
                </div>
                <div class="flex gap-2">
                    <button
                        id="prev-page"
                        class="p-2 rounded bg-blue-600 text-white hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    </button>
                    <button
                        id="next-page"
                        class="p-2 rounded bg-blue-600 text-white hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </button>
                </div>
            </div>
        </div>

    <div class="bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-lg shadow-lg p-3">
        <h2 class="text-xl font-semibold mb-3">Journaux système</h2>
        <div class="p-3 rounded-lg font-mono text-sm bg-gray-100 dark:bg-gray-900 max-h-64 overflow-y-auto">
            <div class="text-green-500">[{{ "now"|date("H:i:s") }}] ✓ Module connecté</div>
            <div class="text-blue-500">[{{ "now"|date("H:i:s") }}] → Récupération des données...</div>
            <div class="text-green-500">[{{ "now"|date("H:i:s") }}] ✓ Données reçues</div>
            <div class="text-gray-500">[{{ "now"|date("H:i:s") }}] ℹ Mise à jour graphiques</div>
            <div class="text-green-500">[{{ "now"|date("H:i:s") }}] ✓ Système opérationnel</div>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const basePath = "{{ basePath }}";

        function getCurrentTheme() {
            return document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        }



        // Database Records Pagination
        const dbRecordsBody = document.getElementById('db-records-body');
        const dbTotalRecordsSpan = document.getElementById('db-total-records');
        const noRecordsMessage = document.getElementById('no-records-message');
        const loadingDbMessage = document.getElementById('loading-db-message');
        const paginationControls = document.getElementById('pagination-controls');
        const currentPageSpan = document.getElementById('current-page');
        const totalPagesSpan = document.getElementById('total-pages');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const refreshDbRecordsBtn = document.getElementById('refresh-db-records');

        let currentPage = 1;
        const recordsPerPage = 20;
        let totalPages = 1;

        async function loadDbRecords(page = 1) {
            loadingDbMessage.classList.remove('hidden');
            dbRecordsBody.innerHTML = ''; // Clear existing records
            noRecordsMessage.classList.add('hidden');
            paginationControls.classList.add('hidden');
            refreshDbRecordsBtn.disabled = true;

            try {
                const response = await fetch(`${basePath}api/diagnostic/paginated?page=${page}&limit=${recordsPerPage}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                
                const records = result.data;
                const pagination = result.pagination;

                if (records.length === 0) {
                    noRecordsMessage.classList.remove('hidden');
                } else {
                    records.forEach(record => {
                        const row = document.createElement('tr');
                        row.className = 'border-t border-gray-300 dark:border-gray-700';
                        row.innerHTML = `
                            <td class="px-4 py-2 font-mono text-xs">
                                ${new Date(record.timestamp).toLocaleString('fr-FR')}
                            </td>
                            <td class="px-4 py-2">${record.papp ?? '-'}</td>
                            <td class="px-4 py-2">${record.hchc ?? '-'}</td>
                            <td class="px-4 py-2">${record.hchp ?? '-'}</td>
                            <td class="px-4 py-2">
                                <span class="px-2 py-1 rounded text-xs ${
                                    record.ptec === '1'
                                        ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'
                                        : record.ptec === '2'
                                        ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
                                        : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200'
                                }">
                                    ${record.ptec === '1' ? 'HC' : record.ptec === '2' ? 'HP' : record.ptec ?? '-'}
                                </span>
                            </td>
                        `;
                        dbRecordsBody.appendChild(row);
                    });
                }

                currentPage = pagination.page;
                totalPages = pagination.totalPages;
                dbTotalRecordsSpan.textContent = pagination.total;
                currentPageSpan.textContent = currentPage;
                totalPagesSpan.textContent = totalPages;

                if (totalPages > 1) {
                    paginationControls.classList.remove('hidden');
                    prevPageBtn.disabled = currentPage <= 1;
                    nextPageBtn.disabled = currentPage >= totalPages;
                    // Les classes sont déjà définies dans le HTML avec les variantes dark:
                } else {
                    paginationControls.classList.add('hidden');
                }

            } catch (error) {
                console.error('Erreur lors du chargement des enregistrements:', error);
                alert('Erreur lors du chargement des enregistrements de la base de données.');
                noRecordsMessage.classList.remove('hidden');
                noRecordsMessage.textContent = 'Erreur lors du chargement des enregistrements.';
            } finally {
                loadingDbMessage.classList.add('hidden');
                refreshDbRecordsBtn.disabled = false;
            }
        }

        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                loadDbRecords(currentPage - 1);
            }
        });

        nextPageBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                loadDbRecords(currentPage + 1);
            }
        });

        refreshDbRecordsBtn.addEventListener('click', () => {
            loadDbRecords(currentPage);
        });

        // Initial load of DB records
        loadDbRecords();

        // Auto refresh every 15 seconds
        setInterval(() => {
            window.location.reload();
        }, 15000);
    });
</script>
{% endblock %}
