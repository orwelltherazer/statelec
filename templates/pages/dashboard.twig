{% extends "base.twig" %}

{% block title %}Dashboard - Statelec{% endblock %}

{% block content %}
<main class="p-4 sm:p-6 space-y-6">
    {# Section des cartes de statistiques #}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
        {# Carte Consommation du jour #}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-500 dark:text-gray-400">Consommation du jour</span>
                {# Icon: Activity #}
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
            </div>
            <div class="text-3xl font-bold">{{ consoDuJour }} kWh</div>
            <div class="text-sm flex items-center mt-2 {{ variationColor }}">
                {% if variationText is not empty %}
                    {% if variationText starts with '+' %}
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1 rotate-180"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
                    {% elseif variationText starts with '-' %}
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></svg>
                    {% endif %}
                {% endif %}
                {{ variationText }}
            </div>
        </div>

        {# Carte Coût estimé #}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 relative group">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-500 dark:text-gray-400">Coût estimé</span>
                {# Icon: DollarSign #}
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
            </div>
            <div class="text-3xl font-bold">{{ coutEstime }} €</div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mt-2">Sur 24h</div>

            {# Tooltip #}
            <div class="hidden group-hover:block absolute z-10 left-0 top-full mt-2 w-full bg-gray-900 text-white text-xs rounded-lg py-2 px-3 shadow-xl">
                <div class="space-y-1">
                    {% if coutBase != '0,00' %}
                        <div class="flex justify-between"><span>Base :</span> <span>{{ coutBase }} €</span></div>
                    {% else %}
                        <div class="flex justify-between"><span>Heures creuses :</span> <span>{{ coutHC }} €</span></div>
                        <div class="flex justify-between"><span>Heures pleines :</span> <span>{{ coutHP }} €</span></div>
                    {% endif %}
                    <div class="flex justify-between border-t border-gray-700 pt-1 mt-1"><span>Abonnement :</span> <span>{{ coutAbo }} €</span></div>
                </div>
            </div>
        </div>

        {# Carte Puissance maximale #}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-500 dark:text-gray-400">Puissance maximale</span>
                {# Icon: BarChart2 #}
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-500"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
            </div>
            <div class="text-3xl font-bold">{{ puissanceMax }} W</div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mt-2">Sur 24h</div>
        </div>

        {# Carte Index HC #}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-500 dark:text-gray-400">Index HC</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            </div>
            <div class="text-2xl font-bold text-blue-500">{{ currentData.hchc }} kWh</div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mt-2">Sur 24h : {{ conso24hHC }} kWh</div>
        </div>

        {# Carte Index HP #}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-500 dark:text-gray-400">Index HP</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-500"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            </div>
            <div class="text-2xl font-bold text-orange-500">{{ currentData.hchp }} kWh</div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mt-2">Sur 24h : {{ conso24hHP }} kWh</div>
        </div>
    </div>

    {# Graphique #}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
        <h2 class="text-lg font-semibold mb-4">Consommation cumulative sur 24h</h2>
        <div style="width: 100%; height: 250px;">
            <canvas id="consumptionChart"></canvas>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chartData = {{ chartData | json_encode | raw }};
        const theme = '{{ theme }}'; // Get theme from PHP

        const labels = chartData.map(d => d.time);
        const indexHcData = chartData.map(d => d.indexHc);
        const indexHpData = chartData.map(d => d.indexHp);

        const ctx = document.getElementById('consumptionChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Consommation HC (kWh)',
                        data: indexHpData,
                        borderColor: '#3b82f6', // blue-500
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.3,
                        pointRadius: 0
                    },
                    {
                        label: 'Consommation HP (kWh)',
                        data: indexHcData,
                        borderColor: '#f97316', // orange-500
                        backgroundColor: 'rgba(249, 115, 22, 0.2)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.3,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        grid: {
                            color: theme === 'dark' ? '#374151' : '#e5e7eb'
                        },
                        ticks: {
                            color: theme === 'dark' ? '#9ca3af' : '#6b7280'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: theme === 'dark' ? '#374151' : '#e5e7eb'
                        },
                        ticks: {
                            color: theme === 'dark' ? '#9ca3af' : '#6b7280'
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: theme === 'dark' ? '#e5e7eb' : '#374151'
                        }
                    },
                    tooltip: {
                        backgroundColor: theme === 'dark' ? '#1f2937' : '#fff',
                        borderColor: theme === 'dark' ? '#374151' : '#e5e7eb',
                        borderWidth: 1,
                        titleColor: theme === 'dark' ? '#e5e7eb' : '#374151',
                        bodyColor: theme === 'dark' ? '#e5e7eb' : '#374151'
                    }
                }
            }
        });
    });
</script>
{% endblock %}

